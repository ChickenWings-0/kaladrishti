<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Kaladrishti | The Divine Pranam Guide</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Cormorant+Garamond:ital,wght@0,300;0,600;0,700;1,400&family=Montserrat:wght@200;400;500;700&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/lucide@latest"></script>


     

    <!-- MediaPipe Requirements -->
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/drawing_utils/drawing_utils.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/holistic/holistic.js" crossorigin="anonymous"></script>

    <style>
        :root {
            --color-bg-dark: #0f0c0b;
            --color-primary: #eebc51;
            --color-accent: #9e1b32;
            --glass-bg: rgba(20, 20, 20, 0.75);
            --glass-border: rgba(238, 188, 81, 0.2);
        }

        body {
            background-color: var(--color-bg-dark);
            color: #f5f2eb;
            font-family: 'Montserrat', sans-serif;
            overflow: hidden;
        }

        h1, h2, h3, .font-display { font-family: 'Cormorant Garamond', serif; }

        .glass-card {
            background: var(--glass-bg);
            backdrop-filter: blur(12px);
            border: 1px solid var(--glass-border);
            box-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.8);
        }

        .text-gold-gradient {
            background: linear-gradient(to bottom right, #fceeb5, #eebc51, #b88a2d);
            -webkit-background-clip: text;
            background-clip: text;
            color: transparent;
        }

        .mirror-mode { transform: scaleX(-1); }

        @keyframes pulse-gold {
            0% { box-shadow: 0 0 0 0 rgba(238, 188, 81, 0.4); }
            70% { box-shadow: 0 0 0 15px rgba(238, 188, 81, 0); }
            100% { box-shadow: 0 0 0 0 rgba(238, 188, 81, 0); }
        }

        .active-step-pulse {
            animation: pulse-gold 2s infinite;
        }

        /* Custom Scrollbar */
        ::-webkit-scrollbar { width: 4px; }
        ::-webkit-scrollbar-thumb { background: var(--color-primary); border-radius: 10px; }
    </style>
</head>
<body class="h-screen w-screen flex flex-col">

    <!-- Header -->
    <header class="z-50 px-8 py-4 flex items-center justify-between glass-card !border-x-0 !border-t-0 !rounded-none">
        <div class="flex items-center gap-3">
            <i data-lucide="feather" class="text-[var(--color-primary)] w-8 h-8"></i>
            <div>
                <h1 class="text-2xl font-bold tracking-widest text-gold-gradient">KALADRISHTI</h1>
                <p class="text-[10px] uppercase tracking-[0.3em] text-gray-400">Pranam Guidance System</p>
            </div>
        </div>
        <div id="connection-status" class="flex items-center gap-2 px-4 py-1 rounded-full bg-black/40 border border-white/10">
            <div class="w-2 h-2 rounded-full bg-red-500 animate-pulse"></div>
            <span class="text-[10px] uppercase font-bold text-gray-400">AI Offline</span>
        </div>
    </header>

    <main class="flex-grow flex relative overflow-hidden">
        
        <!-- Left Sidebar: Instructions & Steps -->
        <aside class="w-80 h-full glass-card border-l-0 border-y-0 p-6 flex flex-col z-20">
            <h2 class="text-2xl font-display mb-6 border-b border-white/10 pb-2">The Ritual of Pranam</h2>
            
            <div id="stepper" class="space-y-6 flex-grow overflow-y-auto pr-2">
                <!-- Step 1 -->
                <div id="step-0" class="relative pl-8 transition-all duration-500 opacity-50">
                    <div class="absolute left-0 top-1 w-5 h-5 rounded-full border-2 border-[var(--color-primary)] flex items-center justify-center text-[10px] font-bold">1</div>
                    <h3 class="font-bold text-white">Anjali Mudra</h3>
                    <p class="text-xs text-gray-400">Join palms at chest height. Feet together. Stand tall.</p>
                </div>
                <!-- Step 2 -->
                <div id="step-1" class="relative pl-8 transition-all duration-500 opacity-50">
                    <div class="absolute left-0 top-1 w-5 h-5 rounded-full border-2 border-gray-600 flex items-center justify-center text-[10px] font-bold">2</div>
                    <h3 class="font-bold text-white">Saluting Earth</h3>
                    <p class="text-xs text-gray-400">Bend deeply and touch the floor with both hands.</p>
                </div>
                <!-- Step 3 -->
                <div id="step-2" class="relative pl-8 transition-all duration-500 opacity-50">
                    <div class="absolute left-0 top-1 w-5 h-5 rounded-full border-2 border-gray-600 flex items-center justify-center text-[10px] font-bold">3</div>
                    <h3 class="font-bold text-white">Seeking Blessings</h3>
                    <p class="text-xs text-gray-400">Bring the fingertips from the floor to your eyes.</p>
                </div>
                <!-- Step 4 -->
                <div id="step-3" class="relative pl-8 transition-all duration-500 opacity-50">
                    <div class="absolute left-0 top-1 w-5 h-5 rounded-full border-2 border-gray-600 flex items-center justify-center text-[10px] font-bold">4</div>
                    <h3 class="font-bold text-white">Completion</h3>
                    <p class="text-xs text-gray-400">Return to Anjali Mudra and offer a gentle bow.</p>
                </div>
            </div>

            <div class="mt-auto pt-6 border-t border-white/10">
                <div class="bg-black/30 p-4 rounded-lg border border-white/5">
                    <p id="ai-coach" class="text-xs italic text-center text-[var(--color-primary)]">"Align yourself to begin..."</p>
                </div>
            </div>
        </aside>

        <!-- Center: Camera Feed -->
        <section class="flex-grow bg-black relative flex items-center justify-center overflow-hidden">
            <video id="webcam" class="absolute inset-0 w-full h-full object-cover mirror-mode opacity-40" autoplay muted playsinline></video>
            <canvas id="output_canvas" class="absolute inset-0 w-full h-full object-cover mirror-mode z-10"></canvas>
            
            <!-- Overlay Info -->
            <div id="loading-overlay" class="absolute inset-0 flex flex-col items-center justify-center bg-black/80 z-50">
                <div class="w-16 h-16 border-4 border-[var(--color-primary)] border-t-transparent rounded-full animate-spin mb-4"></div>
                <p class="text-gold-gradient font-display text-2xl animate-pulse">Initializing Vision Engine...</p>
            </div>

            <!-- Pose Feedback Indicators -->
            <div class="absolute bottom-10 left-1/2 -translate-x-1/2 z-30 flex gap-4">
                <div class="glass-card px-6 py-3 rounded-full flex items-center gap-3">
                    <div id="progress-ring" class="w-10 h-10 rounded-full border-2 border-white/10 relative flex items-center justify-center">
                        <svg class="absolute inset-0 w-full h-full -rotate-90">
                            <circle id="progress-circle" cx="20" cy="20" r="18" fill="none" stroke="var(--color-primary)" stroke-width="3" stroke-dasharray="113.1" stroke-dashoffset="113.1" style="transition: stroke-dashoffset 0.1s linear;"></circle>
                        </svg>
                        <span id="hold-timer" class="text-[10px] font-bold">0s</span>
                    </div>
                    <div>
                        <p class="text-[10px] uppercase tracking-widest text-gray-400">Step Progress</p>
                        <p id="step-name" class="text-sm font-bold">Waiting...</p>
                    </div>
                </div>
            </div>
        </section>

        <!-- Right Panel: Data Analysis -->
        <aside class="w-72 h-full glass-card border-r-0 border-y-0 p-6 z-20 flex flex-col">
            <h2 class="text-xl font-display mb-4">Live Analytics</h2>
            
            <div class="space-y-6">
                <div>
                    <div class="flex justify-between text-[10px] uppercase mb-2">
                        <span>Symmetry</span>
                        <span id="val-symmetry">0%</span>
                    </div>
                    <div class="h-1 w-full bg-white/10 rounded-full overflow-hidden">
                        <div id="bar-symmetry" class="h-full bg-blue-500 w-0 transition-all duration-300"></div>
                    </div>
                </div>

                <div>
                    <div class="flex justify-between text-[10px] uppercase mb-2">
                        <span>Hand Proximity</span>
                        <span id="val-proximity">0%</span>
                    </div>
                    <div class="h-1 w-full bg-white/10 rounded-full overflow-hidden">
                        <div id="bar-proximity" class="h-full bg-green-500 w-0 transition-all duration-300"></div>
                    </div>
                </div>

                <div>
                    <div class="flex justify-between text-[10px] uppercase mb-2">
                        <span>Torso Angle</span>
                        <span id="val-torso">180°</span>
                    </div>
                    <div class="h-1 w-full bg-white/10 rounded-full overflow-hidden">
                        <div id="bar-torso" class="h-full bg-purple-500 w-0 transition-all duration-300"></div>
                    </div>
                </div>
            </div>

            <div class="mt-10 p-4 border border-[var(--color-primary)]/20 rounded-lg bg-[var(--color-primary)]/5">
                <h4 class="text-xs font-bold text-[var(--color-primary)] uppercase mb-2">AI Guidance</h4>
                <ul id="ai-tips" class="text-[10px] text-gray-300 space-y-2 italic">
                    <li>• Ensure your whole body is visible.</li>
                    <li>• Stand in a well-lit area.</li>
                </ul>
            </div>
        </aside>
    </main>

    <!-- Success Modal -->
    <div id="success-modal" class="fixed inset-0 z-[100] bg-black/90 hidden flex flex-col items-center justify-center p-10 text-center">
        <div class="w-32 h-32 rounded-full border-4 border-[var(--color-primary)] flex items-center justify-center mb-6 active-step-pulse">
            <i data-lucide="check" class="w-16 h-16 text-[var(--color-primary)]"></i>
        </div>
        <h2 class="text-5xl font-display text-gold-gradient mb-4">Pranam Complete</h2>
        <p class="text-gray-400 max-w-md mb-8 italic">"You have offered your respects with grace. The journey of dance begins with the Earth's blessing."</p>
        <button onclick="location.reload()" class="px-10 py-3 bg-[var(--color-primary)] text-black font-bold uppercase tracking-widest rounded-full hover:scale-110 transition">Perform Again</button>
    </div>

    <script>
        // --- CONSTANTS & CONFIG ---
        const PRANAM_STAGES = [
            { 
                id: 0, 
                name: "Anjali Mudra", 
                instruction: "Join palms at heart center. Align your spine.",
                tips: ["Connect palms tightly", "Elbows slightly out", "Feet together"]
            },
            { 
                id: 1, 
                name: "Touching the Earth", 
                instruction: "Bend forward and touch the ground. Head down.",
                tips: ["Keep knees slightly soft", "Reach for the floor", "Show humility"]
            },
            { 
                id: 2, 
                name: "Blessing the Eyes", 
                instruction: "Bring fingertips to your eyes as you rise.",
                tips: ["Touch both eyes gently", "Rise slowly", "Maintain balance"]
            },
            { 
                id: 3, 
                name: "Final Offering", 
                instruction: "Return to Namaste and offer a light bow.",
                tips: ["Full circle complete", "Soft focus", "Gratitude"]
            }
        ];

        const state = {
            currentStage: 0,
            holdStartTime: null,
            holdDuration: 1000, // 1 seconds to confirm step
            isComplete: false,
            analytics: {
                symmetry: 0,
                proximity: 0,
                torso: 180
            }
        };

        // --- UTILS ---
        function calculateDistance(a, b) {
            return Math.hypot(a.x - b.x, a.y - b.y, (a.z || 0) - (b.z || 0));
        }

        function calculateAngle(a, b, c) {
            const ba = { x: a.x - b.x, y: a.y - b.y };
            const bc = { x: c.x - b.x, y: c.y - b.y };
            const dot = ba.x * bc.x + ba.y * bc.y;
            const magBA = Math.hypot(ba.x, ba.y);
            const magBC = Math.hypot(bc.x, bc.y);
            return Math.acos(dot / (magBA * magBC)) * (180 / Math.PI);
        }

        // --- CORE LOGIC ---
        const app = {
            init: async () => {
                lucide.createIcons();
                app.setupCamera();
                app.initMediaPipe();
                app.updateUI();
            },

            setupCamera: async () => {
                const video = document.getElementById('webcam');
                try {
                    const stream = await navigator.mediaDevices.getUserMedia({ 
                        video: { width: 1280, height: 720, facingMode: 'user' } 
                    });
                    video.srcObject = stream;
                    await video.play();
                } catch (e) {
                    console.error("Camera Error:", e);
                    alert("Please enable camera access to use the guide.");
                }
            },

            initMediaPipe: () => {
                const holistic = new Holistic({
                    locateFile: (file) => `https://cdn.jsdelivr.net/npm/@mediapipe/holistic/${file}`
                });

                holistic.setOptions({
                    modelComplexity: 1,
                    smoothLandmarks: true,
                    minDetectionConfidence: 0.5,
                    minTrackingConfidence: 0.5
                });

                holistic.onResults(app.onResults);

                const camera = new Camera(document.getElementById('webcam'), {
                    onFrame: async () => {
                        await holistic.send({ image: document.getElementById('webcam') });
                    },
                    width: 1280,
                    height: 720
                });
                camera.start();
            },

            onResults: (results) => {
                document.getElementById('loading-overlay').style.display = 'none';
                document.getElementById('connection-status').querySelector('div').className = 'w-2 h-2 rounded-full bg-green-500';
                document.getElementById('connection-status').querySelector('span').innerText = 'AI Active';

                app.draw(results);
                app.analyzePose(results);
            },

            draw: (results) => {
                const canvas = document.getElementById('output_canvas');
                const ctx = canvas.getContext('2d');
                canvas.width = results.image.width;
                canvas.height = results.image.height;

                ctx.save();
                ctx.clearRect(0, 0, canvas.width, canvas.height);

                if (results.poseLandmarks) {
                    drawConnectors(ctx, results.poseLandmarks, POSE_CONNECTIONS, { color: '#ffffff33', lineWidth: 1 });
                    
                    // Highlight important joints for Pranam
                    const keyJoints = [11, 12, 13, 14, 15, 16, 23, 24]; // Shoulders, Elbows, Wrists, Hips
                    keyJoints.forEach(idx => {
                        const lm = results.poseLandmarks[idx];
                        if (lm) {
                            ctx.beginPath();
                            ctx.arc(lm.x * canvas.width, lm.y * canvas.height, 4, 0, 2 * Math.PI);
                            ctx.fillStyle = state.holdStartTime ? 'var(--color-primary)' : 'white';
                            ctx.fill();
                        }
                    });
                }

                // Hands logic
                if (results.leftHandLandmarks) drawConnectors(ctx, results.leftHandLandmarks, HAND_CONNECTIONS, { color: 'var(--color-primary)', lineWidth: 2 });
                if (results.rightHandLandmarks) drawConnectors(ctx, results.rightHandLandmarks, HAND_CONNECTIONS, { color: 'var(--color-primary)', lineWidth: 2 });

                ctx.restore();
            },

            analyzePose: (results) => {
                if (state.isComplete || !results.poseLandmarks) return;

                const pose = results.poseLandmarks;
                const lWrist = results.leftHandLandmarks?.[0] || pose[15];
                const rWrist = results.rightHandLandmarks?.[0] || pose[16];
                const lHip = pose[23];
                const rHip = pose[24];
                const nose = pose[0];
                const midHip = { x: (lHip.x + rHip.x) / 2, y: (lHip.y + rHip.y) / 2 };

                let isValid = false;

                // 1. Analytics calculation
                const sym = 100 - (Math.abs(pose[11].y - pose[12].y) * 500);
                state.analytics.symmetry = Math.max(0, Math.min(100, Math.round(sym)));
                
                const torsoAngle = calculateAngle(nose, midHip, { x: midHip.x, y: midHip.y + 0.5 });
                state.analytics.torso = Math.round(torsoAngle);

                // 2. Stage Verification
                switch (state.currentStage) {
                    case 0: // Anjali Mudra (Standing)
                        const handDist = calculateDistance(lWrist, rWrist);
                        state.analytics.proximity = Math.max(0, 100 - (handDist * 400));
                        isValid = handDist < 0.1 && torsoAngle > 150 && lWrist.y < midHip.y;
                        break;
                    
                    case 1: // Touching Earth
                        const groundDist = 1 - lWrist.y;
                        state.analytics.proximity = Math.round(groundDist * 100);
                        isValid = torsoAngle < 100 && (lWrist.y > 0.8 || rWrist.y > 0.8);
                        break;
                    
                    case 2: // Blessing Eyes
                        const eyeDistL = calculateDistance(lWrist, pose[2] || pose[0]);
                        const eyeDistR = calculateDistance(rWrist, pose[5] || pose[0]);
                        state.analytics.proximity = Math.max(0, 100 - (eyeDistL * 500));
                        isValid = eyeDistL < 0.15 && eyeDistR < 0.15 && torsoAngle > 130;
                        break;
                    
                    case 3: // Final offering
                        const finalDist = calculateDistance(lWrist, rWrist);
                        isValid = finalDist < 0.1 && torsoAngle > 140;
                        break;
                }

                app.handleStepTiming(isValid);
                app.updateAnalyticsUI();
            },

            handleStepTiming: (isValid) => {
                const now = Date.now();
                if (isValid) {
                    if (!state.holdStartTime) state.holdStartTime = now;
                    const elapsed = now - state.holdStartTime;
                    const progress = Math.min(1, elapsed / state.holdDuration);
                    
                    // Update Circle Progress
                    const circle = document.getElementById('progress-circle');
                    const offset = 113.1 - (progress * 113.1);
                    circle.style.strokeDashoffset = offset;
                    document.getElementById('hold-timer').innerText = (progress * 2).toFixed(1) + 's';

                    if (elapsed >= state.holdDuration) {
                        app.nextStage();
                    }
                } else {
                    state.holdStartTime = null;
                    document.getElementById('progress-circle').style.strokeDashoffset = 113.1;
                    document.getElementById('hold-timer').innerText = '0s';
                }
            },

            nextStage: () => {
                state.holdStartTime = null;
                if (state.currentStage < PRANAM_STAGES.length - 1) {
                    state.currentStage++;
                    app.updateUI();
                } else {
                    state.isComplete = true;
                    document.getElementById('success-modal').classList.remove('hidden');
                }
            },

            updateUI: () => {
                const stage = PRANAM_STAGES[state.currentStage];
                document.getElementById('step-name').innerText = stage.name;
                document.getElementById('ai-coach').innerText = `"${stage.instruction}"`;
                
                // Update Stepper
                PRANAM_STAGES.forEach((s, idx) => {
                    const el = document.getElementById(`step-${idx}`);
                    el.classList.toggle('opacity-100', idx === state.currentStage);
                    el.classList.toggle('opacity-50', idx !== state.currentStage);
                    el.classList.toggle('active-step-pulse', idx === state.currentStage);
                    
                    const dot = el.querySelector('div');
                    if (idx < state.currentStage) {
                        dot.className = "absolute left-0 top-1 w-5 h-5 rounded-full bg-green-500 flex items-center justify-center text-[10px] font-bold text-black";
                        dot.innerHTML = "✓";
                    } else if (idx === state.currentStage) {
                        dot.className = "absolute left-0 top-1 w-5 h-5 rounded-full border-2 border-[var(--color-primary)] flex items-center justify-center text-[10px] font-bold";
                        dot.innerHTML = idx + 1;
                    }
                });

                // Update Tips
                const tipsList = document.getElementById('ai-tips');
                tipsList.innerHTML = stage.tips.map(t => `<li>• ${t}</li>`).join('');
            },

            updateAnalyticsUI: () => {
                document.getElementById('val-symmetry').innerText = state.analytics.symmetry + '%';
                document.getElementById('bar-symmetry').style.width = state.analytics.symmetry + '%';

                document.getElementById('val-proximity').innerText = state.analytics.proximity + '%';
                document.getElementById('bar-proximity').style.width = state.analytics.proximity + '%';

                document.getElementById('val-torso').innerText = state.analytics.torso + '°';
                document.getElementById('bar-torso').style.width = Math.min(100, (state.analytics.torso / 180) * 100) + '%';
            }
        };

        window.onload = app.init;
    </script>
</body>
</html>